From dbbedff0da71f66235e2bfd9f3af60d9179afbff Mon Sep 17 00:00:00 2001
From: Ben Bright <ben.bright@twdb.texas.gov>
Date: Fri, 17 Feb 2023 18:23:29 +0000
Subject: [PATCH] Changes for patch 0002-Added-Support-for-HTML-Email on 2.9.8

---
 ckan/lib/email_notifications.py |  8 ++++++--
 ckan/lib/mailer.py              | 18 ++++++++++--------
 2 files changed, 16 insertions(+), 10 deletions(-)

diff --git a/ckan/lib/email_notifications.py b/ckan/lib/email_notifications.py
index 0552e79706..f621be9c6a 100644
--- a/ckan/lib/email_notifications.py
+++ b/ckan/lib/email_notifications.py
@@ -106,9 +106,13 @@ def _notifications_for_activities(activities, user_dict):
     body = base.render(
             'activity_streams/activity_stream_email_notifications.text',
             extra_vars={'activities': activities})
+    body_html = base.render(
+            'activity_streams/activity_stream_email_notifications.html',
+            extra_vars={'activities': activities})
     notifications = [{
         'subject': subject,
-        'body': body
+        'body': body,
+        'body_html': body_html
         }]
 
     return notifications
@@ -179,7 +183,7 @@ def send_notification(user, email_dict):
 
     try:
         ckan.lib.mailer.mail_recipient(user['display_name'], user['email'],
-                email_dict['subject'], email_dict['body'])
+                email_dict['subject'], email_dict['body'], email_dict['body_html'])
     except ckan.lib.mailer.MailerException:
         raise
 
diff --git a/ckan/lib/mailer.py b/ckan/lib/mailer.py
index dc83eb0f1c..3bf8feba2d 100644
--- a/ckan/lib/mailer.py
+++ b/ckan/lib/mailer.py
@@ -134,7 +134,7 @@ def mail_user(recipient, subject, body, body_html=None, headers={}):
                    body, body_html=body_html, headers=headers)
 
 
-def get_reset_link_body(user):
+def get_reset_link_body(user, kind='txt'):
     extra_vars = {
         'reset_link': get_reset_link(user),
         'site_title': config.get('ckan.site_title'),
@@ -142,10 +142,10 @@ def get_reset_link_body(user):
         'user_name': user.name,
     }
     # NOTE: This template is translated
-    return render('emails/reset_password.txt', extra_vars)
+    return render('emails/reset_password.' + kind, extra_vars)
 
 
-def get_invite_body(user, group_dict=None, role=None):
+def get_invite_body(user, group_dict=None, role=None, kind='txt'):
     if group_dict:
         group_type = (_('organization') if group_dict['is_organization']
                       else _('group'))
@@ -163,7 +163,7 @@ def get_invite_body(user, group_dict=None, role=None):
         extra_vars['group_title'] = group_dict.get('title')
 
     # NOTE: This template is translated
-    return render('emails/invite_user.txt', extra_vars)
+    return render('emails/invite_user.' + kind, extra_vars)
 
 
 def get_reset_link(user):
@@ -176,7 +176,8 @@ def get_reset_link(user):
 
 def send_reset_link(user):
     create_reset_key(user)
-    body = get_reset_link_body(user)
+    body = get_reset_link_body(user, 'txt')
+    body_html = get_reset_link_body(user, 'html')
     extra_vars = {
         'site_title': config.get('ckan.site_title')
     }
@@ -185,12 +186,13 @@ def send_reset_link(user):
     # Make sure we only use the first line
     subject = subject.split('\n')[0]
 
-    mail_user(user, subject, body)
+    mail_user(user, subject, body, body_html)
 
 
 def send_invite(user, group_dict=None, role=None):
     create_reset_key(user)
-    body = get_invite_body(user, group_dict, role)
+    body = get_invite_body(user, group_dict, role, 'txt')
+    body_html = get_invite_body(user, group_dict, role, 'html')
     extra_vars = {
         'site_title': config.get('ckan.site_title')
     }
@@ -199,7 +201,7 @@ def send_invite(user, group_dict=None, role=None):
     # Make sure we only use the first line
     subject = subject.split('\n')[0]
 
-    mail_user(user, subject, body)
+    mail_user(user, subject, body, body_html)
 
 
 def create_reset_key(user):
-- 
2.25.1

