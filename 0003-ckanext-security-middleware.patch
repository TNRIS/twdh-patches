From 6c4373442b4ae459390151e89d357952dda658f9 Mon Sep 17 00:00:00 2001
From: Ben Bright <ben.bright@twdb.texas.gov>
Date: Fri, 17 Feb 2023 17:16:47 +0000
Subject: [PATCH] Changes for patch 0003-ckanext-security-middleware on 2.9.8

---
 ckan/config/middleware/flask_app.py  | 8 +++++++-
 ckan/config/middleware/pylons_app.py | 7 ++++++-
 2 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/ckan/config/middleware/flask_app.py b/ckan/config/middleware/flask_app.py
index 95fdcdb5e2..c7d59b6fb2 100644
--- a/ckan/config/middleware/flask_app.py
+++ b/ckan/config/middleware/flask_app.py
@@ -205,7 +205,10 @@ def make_flask_stack(conf):
             data_dir=cache_dir)
 
     app.wsgi_app = RootPathMiddleware(app.wsgi_app, session_opts)
-    app.wsgi_app = SessionMiddleware(app.wsgi_app, session_opts)
+
+    # Moved as part of ckanext-security patch - next line should be commented out
+    # app.wsgi_app = SessionMiddleware(app.wsgi_app, session_opts)
+
     app.session_interface = BeakerSessionInterface()
 
     # Add Jinja2 extensions and filters
@@ -344,6 +347,9 @@ def make_flask_stack(conf):
         who_parser.remote_user_key
     )
 
+    # Moved as part of ckanext-security patch
+    app = SessionMiddleware(app, session_opts)
+
     # Update the main CKAN config object with the Flask specific keys
     # that were set here or autogenerated
     flask_config_keys = set(flask_app.config.keys()) - set(config.keys())
diff --git a/ckan/config/middleware/pylons_app.py b/ckan/config/middleware/pylons_app.py
index 126fe21f02..36152c89d5 100644
--- a/ckan/config/middleware/pylons_app.py
+++ b/ckan/config/middleware/pylons_app.py
@@ -64,7 +64,9 @@ def make_pylons_stack(conf, full_stack=True, static_files=True,
     # we want to be able to retrieve the routes middleware to be able to update
     # the mapper.  We store it in the pylons config to allow this.
     config['routes.middleware'] = app
-    app = SessionMiddleware(app, config)
+
+    # Moved as part of ckanext-security patch - next line should be commented out
+    # app = SessionMiddleware(app, config)
     app = CacheMiddleware(app, config)
 
     # CUSTOM MIDDLEWARE HERE (filtered by error handling middlewares)
@@ -137,6 +139,9 @@ def make_pylons_stack(conf, full_stack=True, static_files=True,
         who_parser.remote_user_key
     )
 
+    # Moved as part of ckanext-security patch
+    app = SessionMiddleware(app, config)
+
     # Establish the Registry for this application
     app = RegistryManager(app, streaming=False)
 
-- 
2.25.1

